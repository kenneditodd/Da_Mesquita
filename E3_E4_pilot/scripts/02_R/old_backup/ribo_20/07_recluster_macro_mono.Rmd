---
title: "Recluster Myeloid Cells"
author: "Kennedi Todd"
date: "10/16/2022"
output:
  html_document:
    theme: cerulean
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: inline
---

# Setup
## Working directory
```{r working_directory}
knitr::opts_knit$set(
  root.dir = "/research/labs/neurology/fryer/m214960/Da_Mesquita/scripts/R")
```

## Libraries
```{r libraries, message=FALSE, warning=FALSE}
# load packages
library(ComplexUpset) # intersection_size()
library(dplyr)        # ungroup()
library(ggrepel)      # geom_text_repel()
library(gtools)       # smartbind()
library(harmony)      # RunHarmony()
library(parallel)     # detectCores()
library(plotly)       # plot_ly ()
library(Seurat)       # DefaultAssay()
library(ShinyCell)    # createConfig()
library(UpSetR)       # fromList()

# work in parallel
options(mc.cores = detectCores() - 1)
```

## Save functions
```{r save_functions}
saveToPDF <- function(...) {
    d = dev.copy(pdf,...)
    dev.off(d)
}

saveToPNG <- function(...) {
    d = dev.copy(png,...)
    dev.off(d)
}
```

## Set variables
```{r set_colors}
# variables
sample_order <- c("E3.2M.M","E3.2M.F","E4.2M.M","E4.2M.F",
                  "E3.14M.M","E3.14M.F","E4.14M.M","E4.14M.F")
age_order <- c("2 months","14 months")
sex_order <- c("Male","Female")
isoform_order <- c("E3","E4")
sample_colors <- c("gray","red","orange","yellow","green","blue","purple","pink")
age_colors <- c("darkgray","chartreuse3")
sex_colors <- c("darkgray","purple")
isoform_colors <- c("darkgray","cornflowerblue")
sex_isoform_order <- c("Female E3", "Female E4", "Male E3", "Male E4")
sex_isoform_colors <- c("#EAC941","#DF5F00","#26946A","#1814A1")

# set seed
set.seed(8)

# work in parallel
options(mc.cores = detectCores() - 1)
```

## Load data
```{r read_object}
# read object
mouse.annotated <- readRDS("../../rObjects/mouse_annotated.rds")
DefaultAssay(mouse.annotated) <- "RNA"
Idents(mouse.annotated) <- "merged_clusters"

# set colors
cluster_colors <- c("darkred","firebrick1","darkorange","gold","green",
                   "darkolivegreen2","darkgreen","cyan","cornflowerblue","blue",
                   "darkorchid1","deeppink","plum1","burlywood3","azure3","azure4", "black")

# umap
umap <- DimPlot(object = mouse.annotated, 
        reduction = "umap",
        repel = TRUE,
        cols = cluster_colors)
umap
```

# Subset and recluster
## Subset
```{r subset_data}
# subset
macro <- subset(mouse.annotated,
                merged_clusters == "Mrc1+H2-Eb1-low macrophages" |
                  merged_clusters == "Mrc1+H2-Eb1-high macrophages" |
                  merged_clusters == "Monocytes" |
                  merged_clusters == "Mki67+ macrophages")

# plot
macro_colors <- c("darkolivegreen2","darkgreen","cornflowerblue","deeppink")
DimPlot(object = macro,
        reduction = "umap",
        cols = macro_colors)

# create new object
meta <- macro@meta.data
meta <- meta[,c(4:13,25,26)]
colnames(meta)[c(11,12)] <- c("original_individual_clusters","original_merged_clusters")
counts <- GetAssayData(object = macro, slot = "counts")
all.equal(rownames(meta), colnames(counts))
macro <- CreateSeuratObject(counts,
                            meta.data = meta)
```

## Normalize and integrate
- Apply sctransform normalization \
  + Note that this single command replaces NormalizeData(), ScaleData(), and FindVariableFeatures() \
```{r normalize_and_integrate, eval=FALSE}
# Split object by sample
Idents(macro) <- macro$sample
macro.split <- SplitObject(macro, split.by = "sample")

# SCTransform - normalize, scale, find variable features
macro.split <- lapply(macro.split, SCTransform)

# Find variable features of split object
var.features <- SelectIntegrationFeatures(macro.split)

# Merge the samples
macro.sct.merged <- merge(x = macro.split[[1]],
                                y = c(macro.split[[2]], macro.split[[3]],
                                      macro.split[[4]], macro.split[[5]],
                                      macro.split[[6]], macro.split[[7]],
                                      macro.split[[8]]))

# Set variables features for merged object
VariableFeatures(macro.sct.merged) <- var.features

# Run PCA on the merged object
macro.sct.merged <- RunPCA(object = macro.sct.merged, assay = "SCT")

# Harmony dimensional reduction
macro.integrated <- RunHarmony(object = macro.sct.merged,
                                     group.by.vars = "sample", 
                                     assay.use = "SCT",
                                     reduction = "pca")

# Cleanup
remove(mouse.annotated,counts,macro,macro.split,macro.sct.merged)
```

## UMAP and clustering
```{r umap_and_clustering, eval=FALSE}
# Find significant PCs
stdv <- macro.integrated[["pca"]]@stdev
sum.stdv <- sum(macro.integrated[["pca"]]@stdev)
percent.stdv <- (stdv / sum.stdv) * 100
cumulative <- cumsum(percent.stdv)
co1 <- which(cumulative > 90 & percent.stdv < 5)[1]

co2 <- sort(which(
  (percent.stdv[1:length(percent.stdv) - 1] - 
     percent.stdv[2:length(percent.stdv)]) > 0.1), 
  decreasing = T)[1] + 1

min.pc <- min(co1, co2)
min.pc

# Run UMAP
macro.integrated <- RunUMAP(macro.integrated,
                                  dims = 1:min.pc,
                                  reduction = "harmony",
                                  n.components = 3) # set to 3 to use with VR

# Determine the K-nearest neighbor graph
macro.unannotated <- FindNeighbors(object = macro.integrated,
                                         assay = "SCT",
                                         reduction = "harmony",
                                         dims = 1:min.pc)

# Determine the clusters for various resolutions
macro.unannotated <- FindClusters(object = macro.unannotated,
                                        algorithm = 1, # 1 = Louvain
                                        resolution = seq(0.1, 0.5,by = 0.1))
macro.unannotated$seurat_clusters <- macro.unannotated$SCT_snn_res.0.2
Idents(macro.unannotated) <- "seurat_clusters"

# Reset
DefaultAssay(macro.unannotated) <- "RNA"
macro.unannotated <- NormalizeData(macro.unannotated)
macro.unannotated

# save
saveRDS(macro.unannotated, "../../rObjects/mouse_macro_unannotated.rds")
```

```{r,echo=FALSE,eval=TRUE,warning=FALSE,message=FALSE}
macro.unannotated <- readRDS("../../rObjects/mouse_macro_unannotated.rds")
```

## Explore resolutions
```{r explore_resolutions}
# 0.1
DimPlot(macro.unannotated,
        group.by = "SCT_snn_res.0.1",
        label = TRUE)

# 0.2
DimPlot(macro.unannotated,
        group.by = "SCT_snn_res.0.2",
        label = TRUE)

# 0.3
DimPlot(macro.unannotated,
        group.by = "SCT_snn_res.0.3",
        label = TRUE)

# 0.4
DimPlot(macro.unannotated,
        group.by = "SCT_snn_res.0.4",
        label = TRUE)

# 0.5
DimPlot(macro.unannotated,
        group.by = "SCT_snn_res.0.5",
        label = TRUE)
```

## 2D Unannotated UMAP
```{r unannotated_umap}
cluster_colors <- c("firebrick1","gold","green","forestgreen","cyan","blue",
                   "darkorchid1", "pink","gray40")

# Resolution of 0.2, new clusters
DimPlot(macro.unannotated,
        cols = cluster_colors)

# View old annotations/clusters
DimPlot(macro.unannotated,
        group.by = "original_merged_clusters",
        cols = cluster_colors)
```

## 3D Unannotated UMAP
```{r}
embeddings <- macro.unannotated@reductions$umap@cell.embeddings
embeddings <- cbind(embeddings, as.character(macro.unannotated$seurat_clusters))
colnames(embeddings)[4] <- "seurat_clusters"
embeddings <- as.data.frame(embeddings)

three.dim <- plot_ly(embeddings,
                     x = ~UMAP_1, 
                     y = ~UMAP_2, 
                     z = ~UMAP_3, 
                     color = ~seurat_clusters, 
                     colors = cluster_colors,
                     size = 1) 
three.dim <- three.dim %>% add_markers() 
three.dim <- three.dim %>% layout(scene = list(xaxis = list(title = 'UMAP_1'), 
                                     yaxis = list(title = 'UMAP_2'), 
                                     zaxis = list(title = 'UMAP_3')))
three.dim
```

# Potential markers
## Sandro's markers
```{r sandros_markers_unannotated}
goi1 <- c("Pdgfrb","Rgs5","Pecam1","Vwf","Cldn5","Kdr","Prox1","Flt4","Ptprc",
          "Itgam","Aif1","Mrc1","H2-Eb1","Itgax","Ccr2","Ly6c2","Ly6g","Kit",
          "Mki67","Col1a2","Plp1","Trbc2","Gata3","Il7r","Cd19","Ms4a1")

v1 <- VlnPlot(macro.unannotated,
              features = goi1,
              split.by = "seurat_clusters",
              cols = cluster_colors,
              flip = TRUE,
              stack = TRUE) + theme(legend.position = "none")
v1
```

## Automatically detect markers
```{r find_all_markers, eval=FALSE}
# work in parallel
options(mc.cores = detectCores() - 1)

# Find markers for each cluster
# Compares single cluster vs all other clusters
# Default is logfc.threshold = 0.25, min.pct = 0.5
Idents(macro.unannotated) <- "seurat_clusters"
all.markers <- FindAllMarkers(object = macro.unannotated,
                              assay = "RNA",
                              test.use = "MAST",
                              verbose = TRUE)

# add column
all.markers$delta_pct <- abs(all.markers$pct.1 - all.markers$pct.2)

# rename columns and rows
rownames(all.markers) <- 1:nrow(all.markers)
all.markers <- all.markers[,c(6,7,1,5,2:4,8)]
colnames(all.markers)[c(6,7)] <- c("pct_1","pct_2")

# save
saveRDS(all.markers, "../../rObjects/mouse_macro_markers.rds")
```

```{r read_markers_object,echo=FALSE,eval=TRUE}
# read object
all.markers <- readRDS("../../rObjects/mouse_macro_markers.rds")
```

```{r subset_all_markers}
# more stringent filtering
all.markers <- all.markers[all.markers$p_val_adj < 0.01,]

# compare 
table(all.markers$cluster)

# subset
cluster0 <- all.markers[all.markers$cluster == 0,]
cluster1 <- all.markers[all.markers$cluster == 1,]
cluster2 <- all.markers[all.markers$cluster == 2,]
cluster3 <- all.markers[all.markers$cluster == 3,]
cluster4 <- all.markers[all.markers$cluster == 4,]
cluster5 <- all.markers[all.markers$cluster == 5,]
cluster6 <- all.markers[all.markers$cluster == 6,]
cluster7 <- all.markers[all.markers$cluster == 7,]
cluster8 <- all.markers[all.markers$cluster == 8,]

# save
write.table(all.markers,
            "../../../results/ribo_20/reclusterMacro/DEGs/putative_unannotated_cluster_markers_pvaladj_0.01.tsv", 
            sep = "\t", quote = FALSE, row.names = FALSE)
```

# Cluster Annotations
## Cluster 0: H2-Eb1high macrophages 1
```{r cluster0}
# Top 20 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster0$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster0$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = "H2-DMb1",
        split.by = "seurat_clusters",
        cols = cluster_colors)
```

## Cluster 1: Malat1high-H2-Eb1low macrophages
```{r cluster1}
# Top 20 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster1$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster1$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = "Mir99ahg",
        split.by = "seurat_clusters",
        cols = cluster_colors)
```

## Cluster 2: C1qahigh-H2-Eb1low macrophages 1
```{r cluster2}
# Top 20 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster2$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster2$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = "Ccl24",
        split.by = "seurat_clusters",
        cols = cluster_colors)
```

## Cluster 3: C1qahigh-H2-Eb1low macrophages 2
```{r cluster3}
# Top 20 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster3$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster3$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
```

## Cluster 4: H2-Eb1high macrophages 2
```{r cluster4}
# Top 40 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster4$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster4$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = "Gm42418",
        split.by = "seurat_clusters",
        cols = cluster_colors)
```

## Cluster 5: Mgp+ macrophages
```{r cluster5, echo=FALSE, eval=FALSE}
# Top 40 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster5$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster5$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = "Mgp",
        split.by = "seurat_clusters",
        cols = cluster_colors)
```

## Cluster 6: Stat1+-H2-Eb1low macrophages
```{r cluster6, message=FALSE}
# Top 40 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster6$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster6$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = "Ifit2",
        split.by = "seurat_clusters",
        cols = cluster_colors)
```

## Cluster 7: Mki67+ macrophages
```{r cluster7, message=FALSE}
# Top 40 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster7$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster7$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
```

## Cluster 8: Monocytes
```{r cluster8, message=FALSE}
# Top 40 markers based on p_val_adj and then avg_log2FC
VlnPlot(macro.unannotated,
        features = cluster8$gene[1:10],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = cluster8$gene[11:20],
        cols = cluster_colors,
        stack = TRUE,
        flip = TRUE,
        split.by = "seurat_clusters")
VlnPlot(macro.unannotated,
        features = "Mmrn1",
        split.by = "seurat_clusters",
        cols = cluster_colors)
```

## Individual clusters
### Assign
```{r assign_individual_identities}
# Rename all identities
macro.annotated <- RenameIdents(object = macro.unannotated, 
                               "0" = "H2-Eb1high macrophages 1",
                               "1" = "Malat1high-H2-Eb1low macrophages",
                               "2" = "C1qahigh-H2-Eb1low macrophages 1",
                               "3" = "C1qahigh-H2-Eb1low macrophages 2",
                               "4" = "H2-Eb1high macrophages 2",
                               "5" = "Mgp+ macrophages",
                               "6" = "Stat1+-H2-Eb1low macrophages",
                               "7" = "Mki67+ macrophages",
                               "8" = "Monocytes")
macro.annotated$seurat_clusters <- Idents(macro.annotated)
macro.annotated$individual_clusters <- Idents(macro.annotated)
```

### UMAP
```{r individual_annotated_umap}
cluster_colors <- c("firebrick1","gold","green","forestgreen","cyan","blue",
                   "darkorchid1", "pink","gray40")
# View old annotations/clusters
umap <- DimPlot(macro.annotated,
                group.by = "individual_clusters",
                cols = cluster_colors)
umap
```

```{r,eval=FALSE,echo=FALSE}
path <- "../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_individual_clusters"
umap
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()
```

## Merged clusters
### Assign
```{r assign_merged_identities}
# Rename all identities
macro.merged <- RenameIdents(object = macro.unannotated, 
                               "0" = "H2-Eb1high macrophages",
                               "1" = "Malat1high-H2-Eb1low macrophages",
                               "2" = "C1qahigh-H2-Eb1low macrophages",
                               "3" = "C1qahigh-H2-Eb1low macrophages",
                               "4" = "H2-Eb1high macrophages",
                               "5" = "Mgp+ macrophages",
                               "6" = "Stat1+-H2-Eb1low macrophages",
                               "7" = "Mki67+ macrophages",
                               "8" = "Monocytes")
macro.annotated$merged_clusters <- Idents(macro.merged)
macro.annotated$seurat_clusters <- macro.annotated$merged_clusters
```

### UMAP
```{r merged_annotated_umap}
cluster_colors <- c("firebrick1","gold","green","forestgreen","cyan","blue",
                   "gray40")
# View old annotations/clusters
umap <- DimPlot(macro.annotated,
                group.by = "merged_clusters",
                cols = cluster_colors)
umap
```

```{r,eval=FALSE,echo=FALSE}
path <- "../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_clusters"
umap
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()
```

```{r, eval=FALSE, echo=FALSE}
#saveRDS(macro.annotated, "../../../rObjects/mouse_macro_annotated.rds")
macro.annotated <- readRDS("../../../rObjects/mouse_macro_annotated.rds")
```

# Clustering QC after annotation
## 3D UMAP
```{r}
embeddings <- macro.annotated@reductions$umap@cell.embeddings
embeddings <- cbind(embeddings, as.character(macro.annotated$seurat_clusters))
colnames(embeddings)[4] <- "seurat_clusters"
embeddings <- as.data.frame(embeddings)

three.dim <- plot_ly(embeddings,
                     x = ~UMAP_1, 
                     y = ~UMAP_2, 
                     z = ~UMAP_3, 
                     color = ~seurat_clusters, 
                     colors = cluster_colors,
                     size = 1) 
three.dim <- three.dim %>% add_markers() 
three.dim <- three.dim %>% layout(scene = list(xaxis = list(title = '1'), 
                                     yaxis = list(title = '2'), 
                                     zaxis = list(title = '3')))
three.dim
```

## UMAP
```{r umap_annotated}
# Apoe isoform
umap1 <- DimPlot(object = macro.annotated, 
                 group.by = "seurat_clusters",
                 reduction = "umap",
                 split.by = "isoform",
                 repel = TRUE,
                 cols = cluster_colors)
umap1

# age
umap2 <- DimPlot(object = macro.annotated, 
                 group.by = "seurat_clusters",
                 reduction = "umap",
                 split.by = "age",
                 repel = TRUE,
                 cols = cluster_colors)
umap2

# sex
umap3 <- DimPlot(object = macro.annotated, 
                 group.by = "seurat_clusters",
                 reduction = "umap",
                 split.by = "sex",
                 repel = TRUE,
                 cols = cluster_colors)
umap3

# sample
umap4 <- DimPlot(object = macro.annotated, 
                 group.by = "seurat_clusters",
                 reduction = "umap",
                 split.by = "sample",
                 ncol = 2,
                 repel = TRUE,
                 cols = cluster_colors)
umap4

# phase
umap5 <- DimPlot(object = macro.annotated, 
                 group.by = "seurat_clusters",
                 reduction = "umap",
                 split.by = "Phase",
                 cols = cluster_colors,
                 repel = TRUE)
umap5

# mito.factor
umap6 <- DimPlot(object = macro.annotated, 
                 group.by = "seurat_clusters",
                 reduction = "umap",
                 split.by = "mito.factor",
                 cols = cluster_colors,
                 ncol = 2,
                 repel = TRUE)
umap6
```

```{r, echo=FALSE, eval=FALSE}
umap1
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_isoform")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap2
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_age")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap3
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_sex")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap4
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_sample")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap5
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_phase")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap6
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_mito.factor")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

remove(umap1,umap2,umap3,umap4,umap5,umap6)
```

## Female E3, Female E4, Male E3, Male E4
### Frequency
```{r}
# new column
sex.isoform <- paste(macro.annotated$sex, macro.annotated$isoform)
macro.annotated$sex_isoform <- factor(sex.isoform, levels = sex_isoform_order)

# frequency table for sex and isoform
df <- table(macro.annotated$sex_isoform)
path <- "../../../results/ribo_20/reclusterMacro/numCells/"
write.table(df, paste0(path,"cells_per_sex&isoform.tsv"),
            sep = "\t", quote = FALSE, col.names = FALSE, row.names = FALSE)

# frequency per cluster table
sex_isoform_ncells <- FetchData(macro.annotated, 
                     vars = c("ident", "sex_isoform")) %>%
  dplyr::count(ident, sex_isoform) %>%
  tidyr::spread(ident, n)
sex_isoform_ncells
write.table(sex_isoform_ncells, 
            paste0(path,"cells_per_cluster_per_sex&isoform_annotated.tsv"),
            quote = FALSE, sep = "\t", row.names = FALSE)

# frequency per sex & isoform
data <- as.data.frame(table(macro.annotated$sex_isoform))
colnames(data) <- c("sex_isoform","frequency")
ncells1 <- ggplot(data, aes(x = sex_isoform, 
                            y = frequency, 
                            fill = sex_isoform)) + 
  geom_col() +
  theme_classic() +
  geom_text(aes(label = frequency), 
            position=position_dodge(width=0.9), 
            vjust=-0.25) +
  scale_y_continuous(breaks = seq(0,3500, by = 500), limits = c(0,3500)) +
  ggtitle("Cells per sex and isoform") +
  scale_fill_manual(values = sex_isoform_colors) +
  theme(legend.position =  "none") + 
  theme(axis.text.x = element_text(angle = 45, hjust=1))
ncells1

# frequency per cluster sex & isoform
df <- melt(sex_isoform_ncells)
colnames(df) <- c("sex_isoform","cluster","number_of_cells")
ncells2 <- ggplot(df, aes(x = cluster, y = number_of_cells)) + 
  geom_bar(aes(fill = sex_isoform), position = "dodge", stat="identity") +
  theme_classic() +
  geom_text(aes(label = number_of_cells, fill = sex_isoform), 
            position=position_dodge(width=0.9), 
            hjust=0, angle=90) +
  scale_y_continuous(breaks = seq(0,800, by = 200), limits = c(0,800)) +
  ggtitle("Cells per cluster per sex & isoform") +
  scale_fill_manual(values = sex_isoform_colors) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  xlab("Cluster") + ylab("Number of Cells")
ncells2
```

```{r}
ncells1
path <- paste0("../../../results/ribo_20/reclusterMacro/numCells/cells_per_sex&isoform_bar_graph")
saveToPDF(paste0(path, ".pdf"), width = 6, height = 6)
dev.off()

ncells2
path <- paste0("../../../results/ribo_20/reclusterMacro/numCells/cells_per_cluster_per_sex&isoform_bar_graph")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 6)
dev.off()
```

### UMAP
```{r}
# split
umap7 <- DimPlot(object = macro.annotated, 
                 group.by = "merged_clusters",
                 reduction = "umap",
                 split.by = "sex_isoform",
                 cols = cluster_colors,
                 ncol = 2,
                 repel = TRUE)
umap7

# Female E3
female.e3 <- subset(macro.annotated, sex_isoform == "Female E3")
umap8 <- DimPlot(object = female.e3, 
                 group.by = "merged_clusters",
                 reduction = "umap",
                 split.by = "sex_isoform",
                 cols = cluster_colors,
                 ncol = 2,
                 repel = TRUE)
umap8
remove(female.e3)

# Female E4
female.e4 <- subset(macro.annotated, sex_isoform == "Female E4")
umap9 <- DimPlot(object = female.e4, 
                 group.by = "merged_clusters",
                 reduction = "umap",
                 split.by = "sex_isoform",
                 cols = cluster_colors,
                 ncol = 2,
                 repel = TRUE)
umap9
remove(female.e4)

# Male E3
male.e3 <- subset(macro.annotated, sex_isoform == "Male E3")
umap10 <- DimPlot(object = male.e3, 
                 group.by = "merged_clusters",
                 reduction = "umap",
                 split.by = "sex_isoform",
                 cols = cluster_colors,
                 ncol = 2,
                 repel = TRUE)
umap10
remove(male.e3)

# Male E4
male.e4 <- subset(macro.annotated, sex_isoform == "Male E4")
umap11 <- DimPlot(object = male.e4, 
                 group.by = "merged_clusters",
                 reduction = "umap",
                 split.by = "sex_isoform",
                 cols = cluster_colors,
                 ncol = 2,
                 repel = TRUE)
umap11
```

```{r, echo=FALSE, eval=FALSE}
umap7
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_sex&isoform_split")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap8
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_female_e3")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap9
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_female_e4")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap10
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_male_e3")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

umap11
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_male_e4")
saveToPDF(paste0(path, ".pdf"), width = 12, height = 8)
dev.off()

remove(umap7,umap8,umap9,umap10,umap11)
```

### Feature plots
```{r}
# Genes of interest
goi <- c("H2-Eb1", "Cd74", "B2m", "Cst3", "Ctss", "Cd36", "Timp2", "Ftl1", 
         "Itgb1", "Lcn2", "Ifngr1", "Lgals3", "Mgp", "Nlrp3", "Ccl5", "Hexb", 
         "Stab1", "Flt4", "Kdr")

# subset
female.e3 <- subset(macro.annotated, sex_isoform == "Female E3")
female.e4 <- subset(macro.annotated, sex_isoform == "Female E4")
male.e3 <- subset(macro.annotated, sex_isoform == "Male E3")
male.e4 <- subset(macro.annotated, sex_isoform == "Male E4")

# loop through genes
for (i in goi) {
  
  # indvidual plots
  # female e3
  p1 <- FeaturePlot(object = female.e3,
                    raster = FALSE,
                    features = i) +
    scale_colour_gradientn(colours = c("blue","lightblue","yellow","orange","red"))
  path <- "../../../results/ribo_20/reclusterMacro/GOI/"
  pdf(paste0(path,i,"_female_e3_feature_plot.pdf"), height = 4, width = 4)
  print(p1)
  dev.off()
  # female e4
  p2 <- FeaturePlot(object = female.e4,
                    raster = FALSE,
                    features = i) +
    scale_colour_gradientn(colours = c("blue","lightblue","yellow","orange","red"))
  pdf(paste0(path,i,"_female_e4_feature_plot.pdf"), height = 4, width = 4)
  print(p2)
  dev.off()
  # male e3
  p3 <- FeaturePlot(object = male.e3,
                    raster = FALSE,
                    features = i) +
    scale_colour_gradientn(colours = c("blue","lightblue","yellow","orange","red"))
  pdf(paste0(path,i,"_male_e3_feature_plot.pdf"), height = 4, width = 4)
  print(p3)
  dev.off()
  # male e4
  p4 <- FeaturePlot(object = male.e4,
                    raster = FALSE,
                    features = i) +
    scale_colour_gradientn(colours = c("blue","lightblue","yellow","orange","red"))
  pdf(paste0(path,i,"_male_e4_feature_plot.pdf"), height = 4, width = 4)
  print(p4)
  dev.off()
  
  # grid
  pdf(paste0(path,i,"_sex_isoform_split_feature_plot.pdf"), height = 8, width = 8)
  plots <- list(p1,p2,p3,p4)
  layout <- rbind(c(1,3),c(2,4))
  grid <- grid.arrange(grobs = plots, layout_matrix = layout)
  dev.off()
  
  # cleanup
  remove(p1,p2,p3,p4,plots,layout,grid)
}
```

```{r}
p1
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_percent.mt")
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

p2
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_nCount")
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

p3
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_nFeature")
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

p4
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_percent.ribo")
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

#remove(p1,p2,p3,p4)
```

## Feature plots
```{r feature_plots_annotated, warning=FALSE, message=FALSE}
# UMAP percent.mt
f1 <- FeaturePlot(macro.annotated, 
            reduction = "umap", 
            features = "percent.mt")  + 
  scale_colour_gradientn(colours = c("blue","lightblue","yellow","orange","red"))
f1

# UMAP nCount
f2 <- FeaturePlot(macro.annotated, 
            reduction = "umap",
            features = "nCount_RNA") + 
  scale_colour_gradientn(colours = c("blue","lightblue","yellow","orange","red"))
f2

# UMAP nFeature
f3 <- FeaturePlot(macro.annotated, 
            reduction = "umap", 
            features = "nFeature_RNA") + 
  scale_colour_gradientn(colours = c("blue","lightblue","yellow","orange","red"))
f3

# UMAP percent.ribo
f4 <- FeaturePlot(macro.annotated, 
            reduction = "umap", 
            features = "percent.ribo.protein") + 
  scale_colour_gradientn(colours = c("blue","lightblue","yellow","orange","red"))
f4
```

```{r, echo=FALSE, eval=FALSE}
f1
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_percent.mt")
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

f2
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_nCount")
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

f3
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_nFeature")
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

f4
path <- paste0("../../../results/ribo_20/reclusterMacro/UMAP/UMAP_annotated_merged_percent.ribo")
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

remove(f1,f2,f3,f4)
```

## Ttr
```{r}
VlnPlot(macro.annotated,
        features = "Ttr",
        split.by = "sample",
        group.by = "sample",
        cols = sample_colors)
VlnPlot(macro.annotated,
        features = "Ttr",
        split.by = "seurat_clusters",
        cols = cluster_colors)
FeaturePlot(object = macro.annotated, 
            features = "Ttr")
```

## Percent cells per cluster
```{r percent_cells}
# isoform
b1 <- macro.annotated@meta.data %>%
  group_by(seurat_clusters, isoform) %>%
  dplyr::count() %>%
  group_by(seurat_clusters) %>%
  dplyr::mutate(percent = 100*n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=seurat_clusters,y=percent, fill=isoform)) +
  theme_classic() +
  geom_col() +
  scale_fill_manual(values = isoform_colors) +
  ggtitle("Percentage of isoform per cluster") +
  theme(axis.text.x = element_text(angle = 90))
b1

# sex
b2 <- macro.annotated@meta.data %>%
  group_by(seurat_clusters, sex) %>%
  dplyr::count() %>%
  group_by(seurat_clusters) %>%
  dplyr::mutate(percent = 100*n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=seurat_clusters,y=percent, fill=sex)) +
  theme_classic() +
  geom_col() +
  scale_fill_manual(values = sex_colors) +
  ggtitle("Percentage of sex per cluster") +
  theme(axis.text.x = element_text(angle = 90))
b2

# age
b3 <- macro.annotated@meta.data %>%
  group_by(seurat_clusters, age) %>%
  dplyr::count() %>%
  group_by(seurat_clusters) %>%
  dplyr::mutate(percent = 100*n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=seurat_clusters,y=percent, fill=age)) +
  theme_classic() +
  geom_col() +
  scale_fill_manual(values = age_colors) +
  ggtitle("Percentage of age per cluster") +
  theme(axis.text.x = element_text(angle = 90))
b3

# sample
b4 <- macro.annotated@meta.data %>%
  group_by(seurat_clusters, sample) %>%
  dplyr::count() %>%
  group_by(seurat_clusters) %>%
  dplyr::mutate(percent = 100*n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=seurat_clusters,y=percent, fill=sample)) +
  theme_classic() +
  geom_col() +
  scale_fill_manual(values = sample_colors) +
  ggtitle("Percentage of sample per cluster") +
  theme(axis.text.x = element_text(angle = 90))

# phase
b5 <- macro.annotated@meta.data %>%
  group_by(seurat_clusters, Phase) %>%
  dplyr::count() %>%
  group_by(seurat_clusters) %>%
  dplyr::mutate(percent = 100*n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=seurat_clusters,y=percent, fill=Phase)) +
  theme_classic() +
  geom_col() +
  ggtitle("Percentage of phase per cluster") +
  theme(axis.text.x = element_text(angle = 90))
b5

# mito.factor
b6 <- macro.annotated@meta.data %>%
  group_by(seurat_clusters, mito.factor) %>%
  dplyr::count() %>%
  group_by(seurat_clusters) %>%
  dplyr::mutate(percent = 100*n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=seurat_clusters,y=percent, fill=mito.factor)) +
  theme_classic() +
  geom_col() +
  ggtitle("Percentage of mito.factor per cluster") +
  theme(axis.text.x = element_text(angle = 90))
b6

# mito.factor
b7 <- macro.annotated@meta.data %>%
  group_by(seurat_clusters, sex_isoform) %>%
  dplyr::count() %>%
  group_by(seurat_clusters) %>%
  dplyr::mutate(percent = 100*n/sum(n)) %>%
  ungroup() %>%
  ggplot(aes(x=seurat_clusters,y=percent, fill=sex_isoform)) +
  theme_classic() +
  geom_col() +
  scale_fill_manual(values = sex_isoform_colors) +
  ggtitle("Percentage of sex & isoform per cluster") +
  theme(axis.text.x = element_text(angle = 90))
b7
```

```{r,echo=FALSE,eval=FALSE}
# save
b1
path <- "../../../results/ribo_20/reclusterMacro/percentCells/percent_isoform_per_cluster_annotated"
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

# save
b2
path <- "../../../results/ribo_20/reclusterMacro/percentCells/percent_sex_per_cluster_annotated"
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

# save
b3
path <- "../../../results/ribo_20/reclusterMacro/percentCells/percent_age_per_cluster_annotated"
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

# save
b4
path <- "../../../results/ribo_20/reclusterMacro/percentCells/percent_sample_per_cluster_annotated"
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

# save
b5
path <- "../../../results/ribo_20/reclusterMacro/percentCells/percent_phase_per_cluster_annotated"
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

# save
b6
path <- "../../../results/ribo_20/reclusterMacro/percentCells/percent_mito_factor_per_cluster_annotated"
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

# save
b7
path <- "../../../results/ribo_20/reclusterMacro/percentCells/percent_sex&isoform_per_cluster_annotated"
saveToPDF(paste0(path, ".pdf"), width = 8, height = 6)
dev.off()

# cleanup
remove(b1,b2,b3,b4,b5,b6,b7)
```

## Number cells per cluster
```{r cells_per_cluster}
# clusters
cluster_ncells <- FetchData(macro.annotated, 
                     vars = c("merged_clusters")) %>%
  dplyr::count(merged_clusters)
cluster_ncells
write.table(cluster_ncells, 
            "../../../results/ribo_20/reclusterMacro/numCells/cells_per_cluster_annotated.tsv",
            quote = FALSE, sep = "\t", row.names = FALSE)

# sample
sample_ncells <- FetchData(macro.annotated, 
                     vars = c("ident", "sample")) %>%
  dplyr::count(ident, sample) %>%
  tidyr::spread(ident, n)
sample_ncells
write.table(sample_ncells, 
            "../../../results/ribo_20/reclusterMacro/numCells/cells_per_cluster_per_sample_annotated.tsv",
            quote = FALSE, sep = "\t", row.names = FALSE)

# age
age_ncells <- FetchData(macro.annotated, 
                     vars = c("ident", "age")) %>%
  dplyr::count(ident, age) %>%
  tidyr::spread(ident, n)
age_ncells
write.table(age_ncells, 
            "../../../results/ribo_20/reclusterMacro/numCells/cells_per_cluster_per_age_annotated.tsv",
            quote = FALSE, sep = "\t", row.names = FALSE)

# sex
sex_ncells <- FetchData(macro.annotated, 
                     vars = c("ident", "sex")) %>%
  dplyr::count(ident, sex) %>%
  tidyr::spread(ident, n)
sex_ncells
write.table(sex_ncells, 
            "../../../results/ribo_20/reclusterMacro/numCells/cells_per_cluster_per_sex_annoated.tsv",
            quote = FALSE, sep = "\t", row.names = FALSE)

# isoform
isoform_ncells <- FetchData(macro.annotated, 
                     vars = c("ident", "isoform")) %>%
  dplyr::count(ident, isoform) %>%
  tidyr::spread(ident, n)
isoform_ncells
write.table(isoform_ncells, 
            "../../../results/ribo_20/reclusterMacro/numCells/cells_per_cluster_per_isoform_annotated.tsv",
            quote = FALSE, sep = "\t", row.names = FALSE)

# phase
phase_ncells <- FetchData(macro.annotated, 
                     vars = c("ident", "Phase")) %>%
  dplyr::count(ident, Phase) %>%
  tidyr::spread(ident, n)
phase_ncells
write.table(phase_ncells, 
            "../../../results/ribo_20/reclusterMacro/numCells/cells_per_cluster_per_phase_annotated.tsv",
            quote = FALSE, sep = "\t", row.names = FALSE)

# sex and isoform
sex_iso_ncells <- FetchData(macro.annotated, 
                     vars = c("ident", "sex_isoform")) %>%
  dplyr::count(ident, sex_isoform) %>%
  tidyr::spread(ident, n)
sex_iso_ncells
write.table(sex_iso_ncells, 
            "../../../results/ribo_20/reclusterMacro/numCells/cells_per_cluster_per_sex&isoform_annotated.tsv",
            quote = FALSE, sep = "\t", row.names = FALSE)
```


## Cluster tree
```{r cluster_tree_indv_annotated, message=FALSE, warning=FALSE}
Idents(macro.annotated) <- macro.annotated$seurat_clusters
macro.annotated <- BuildClusterTree(object = macro.annotated,
                                     dims = 1:15,
                                     reorder = FALSE,
                                     reorder.numeric = FALSE)

tree <- macro.annotated@tools$BuildClusterTree
tree$tip.label <- paste0(tree$tip.label)

p <- ggtree::ggtree(tree, aes(x, y)) +
  scale_y_reverse() +
  ggtree::geom_tree() +
  ggtree::theme_tree() +
  ggtree::geom_tiplab(offset = 1) +
  ggtree::geom_tippoint(color = cluster_colors[1:length(tree$tip.label)], shape = 16, size = 5) +
  coord_cartesian(clip = 'off') +
  theme(plot.margin = unit(c(0,2.5,0,0), 'cm'))
p
```

## Stacked violins
```{r Sandros_markers_annotated, eval=FALSE}
goi1 <- c("Pdgfrb","Rgs5","Pecam1","Vwf","Cldn5","Kdr","Prox1","Flt4","Ptprc",
          "Itgam","Aif1","Mrc1","H2-Eb1","Itgax","Ccr2","Ly6c2","Ly6g","Kit",
          "Mki67","Col1a2","Plp1","Trbc2","Gata3","Il7r","Cd19","Ms4a1")
goi2 <- c("Kdr","Flt4","Prox1","Lyve1","Nrp2","Itga9","Itgb1","Grb2","Tnc","Plcg1","Crk")
goi3 <- c("Vegfc","Vegfd","Nrp2","Itga9","Itgb1","Grb2","Vcam1","Fn1","Crk","Sema3c","Sema3f")
goi4 <- c("Apoe","H2-Eb1","Cd74","B2m","Stat1","C1qa","Cd36","Flt1","Hexb","Ifngr1")
Idents(macro.annotated) <- "seurat_clusters"

v1 <- VlnPlot(macro.annotated, 
        features = goi1,
        split.by = 'seurat_clusters',
        cols = cluster_colors,
        flip = TRUE,
        stack = TRUE) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 90))
v1

v2 <- VlnPlot(macro.annotated,
              features = goi2,
              cols = isoform_colors,
              split.by = "isoform",
              group.by = "seurat_clusters",
              flip = TRUE,
              stack = TRUE) +
  theme(axis.text.x = element_text(angle = 90))
v2

v3 <- VlnPlot(macro.annotated,
              features = goi2,
              cols = sex_colors,
              split.by = "sex",
              group.by = "seurat_clusters",
              flip = TRUE,
              stack = TRUE) +
  theme(axis.text.x = element_text(angle = 90))
v3

v4 <- VlnPlot(macro.annotated,
              features = goi2,
              cols = age_colors,
              split.by = "age",
              group.by = "seurat_clusters",
              flip = TRUE,
              stack = TRUE) +
  theme(axis.text.x = element_text(angle = 90))
v4

v5 <- VlnPlot(macro.annotated,
              features = goi3,
              cols = isoform_colors,
              split.by = "isoform",
              group.by = "seurat_clusters",
              flip = TRUE,
              stack = TRUE) +
  theme(axis.text.x = element_text(angle = 90))
v5

v6 <- VlnPlot(macro.annotated,
              features = goi3,
              cols = sex_colors,
              split.by = "sex",
              group.by = "seurat_clusters",
              flip = TRUE,
              stack = TRUE) +
  theme(axis.text.x = element_text(angle = 90))
v6

v7 <- VlnPlot(macro.annotated,
              features = goi3,
              cols = age_colors,
              split.by = "age",
              group.by = "seurat_clusters",
              flip = TRUE,
              stack = TRUE) +
  theme(axis.text.x = element_text(angle = 90))
v7

v8 <- VlnPlot(macro.annotated,
              features = goi4,
              cols = sex_isoform_colors,
              split.by = "sex_isoform",
              group.by = "individual_clusters",
              flip = TRUE,
              stack = TRUE) +
  theme(axis.text.x = element_text(angle = 90))
v8
```


```{r, echo=FALSE, eval=FALSE}
path <- "../../../results/ribo_20/reclusterMacro/violins/stacked_violins"

v1
saveToPDF(paste0(path, "1.pdf"), width = 10, height = 10)
dev.off()

v2
saveToPDF(paste0(path, "2_split_isoform.pdf"), width = 10, height = 10)
dev.off()

v3
saveToPDF(paste0(path, "3_split_sex.pdf"), width = 10, height = 10)
dev.off()

v4
saveToPDF(paste0(path, "4_split_age.pdf"), width = 10, height = 10)
dev.off()

v5
saveToPDF(paste0(path, "5_split_isoform.pdf"), width = 10, height = 10)
dev.off()

v6
saveToPDF(paste0(path, "6_split_sex.pdf"), width = 10, height = 10)
dev.off()

v7
saveToPDF(paste0(path, "7_split_age.pdf"), width = 10, height = 10)
dev.off()

v8
saveToPDF(paste0(path, "8_split_sex&isoform.pdf"), width = 10, height = 10)
dev.off()

# cleanup
remove(v1,v2,v3,v4,v5,v6,v7,v8)
```

# Differential expression
## E4 vs E3 within each cluster
```{r isoform_de, warning=FALSE, message=FALSE, eval=FALSE}
# intitialize variables
cell_types <- unique(macro.annotated$seurat_clusters)
isoform.df <- data.frame()

# loop through clusters
for (i in cell_types) {
  print(i)
  cluster <- subset(macro.annotated, seurat_clusters == i)
  Idents(cluster) <- cluster$isoform
  markers <- FindMarkers(object = cluster,
                         ident.1 = "E4",
                         ident.2 = "E3",
                         only.pos = FALSE, # default
                         min.pct = 0.10,  # default
                         test.use = "MAST",
                         verbose = TRUE,
                         assay = "RNA")
  if(nrow(markers) == 0) {
    next
  }
  markers$cluster <- i
  markers$gene <- rownames(markers)
  isoform.df <- rbind(isoform.df, markers)
}

# reformat table
colnames(isoform.df)[c(3,4)] <- c("percent_E4","percent_E3")
rownames(isoform.df) <- 1:nrow(isoform.df)
isoform.df$percent_difference <- abs(isoform.df$percent_E4 - isoform.df$percent_E3)
isoform.df <- isoform.df[,c(6,7,1,5,2,3,4,8)]

# write table
write.table(isoform.df, "../../../results/ribo_20/reclusterMacro/DEGs/E4_vs_E3_DEGs.tsv", 
            sep = "\t", quote = FALSE, row.names = FALSE)
```

## Female vs male within each cluster
```{r sex_de, warning=FALSE, message=FALSE, eval=FALSE}
cell_types <- unique(macro.annotated$seurat_clusters)
sex.df <- data.frame()

for (i in cell_types) {
  print(i)
  cluster <- subset(macro.annotated, seurat_clusters == i)
  Idents(cluster) <- cluster$sex
  markers <- FindMarkers(object = cluster,
                         ident.1 = "Female",
                         ident.2 = "Male",
                         only.pos = FALSE, # default
                         min.pct = 0.10,  # default
                         test.use = "MAST",
                         verbose = TRUE,
                         assay = "RNA")
  if(nrow(markers) == 0) {
    next
  }
  markers$cluster <- i
  markers$gene <- rownames(markers)
  sex.df <- rbind(sex.df, markers)
}

# reformat table
colnames(sex.df)[c(3,4)] <- c("percent_female","percent_male")
rownames(sex.df) <- 1:nrow(sex.df)
sex.df$percent_difference <- abs(sex.df$percent_female - sex.df$percent_male)
sex.df <- sex.df[,c(6,7,1,5,2,3,4,8)]

# write table
write.table(sex.df, 
            "../../../results/ribo_20/reclusterMacro/DEGs/female_vs_male_DEGs.tsv", sep = "\t",
            quote = FALSE, row.names = FALSE)
```

## 14 vs 2 months within each cluster
```{r age_de, warning=FALSE, message=FALSE, eval=FALSE}
# initialize variables
cell_types <- unique(macro.annotated$seurat_clusters)
age.df <- data.frame()

# loop through clusters
for (i in cell_types) {
  print(i)
  cluster <- subset(macro.annotated, seurat_clusters == i)
  Idents(cluster) <- cluster$age
  markers <- FindMarkers(object = cluster,
                         ident.1 = "14 months",
                         ident.2 = "2 months",
                         only.pos = FALSE, # default
                         min.pct = 0.10,  # default
                         test.use = "MAST",
                         verbose = TRUE,
                         assay = "RNA")
  if(nrow(markers) == 0) {
    next
  }
  markers$cluster <- i
  markers$gene <- rownames(markers)
  age.df <- rbind(age.df, markers)
}

# reformat table
colnames(age.df)[c(3,4)] <- c("percent_14mo","percent_2mo")
rownames(age.df) <- 1:nrow(age.df)
age.df$percent_difference <- abs(age.df$percent_14mo - age.df$percent_2mo)
age.df <- age.df[,c(6,7,1,5,2,3,4,8)]

# write table
write.table(age.df, 
            "../../../results/ribo_20/reclusterMacro/DEGs/14_vs_2_months_DEGs.tsv", sep = "\t",
            quote = FALSE, row.names = FALSE)
```

## Male E4 vs Male E3, 
```{r age_de, warning=FALSE, message=FALSE, eval=FALSE}
# initialize variables
cell_types <- unique(macro.annotated$seurat_clusters)
df <- data.frame()

# loop through clusters
for (i in cell_types) {
  print(i)
  cluster <- subset(macro.annotated, seurat_clusters == i)
  Idents(cluster) <- cluster$sex_isoform
  markers <- FindMarkers(object = cluster,
                         ident.1 = "Male E4",
                         ident.2 = "Male E3",
                         only.pos = FALSE, # default
                         min.pct = 0.10,  # default
                         test.use = "MAST",
                         verbose = TRUE,
                         assay = "RNA")
  if(nrow(markers) == 0) {
    next
  }
  markers$cluster <- i
  markers$gene <- rownames(markers)
  df <- rbind(df, markers)
}

# reformat table
colnames(df)[c(3,4)] <- c("percent_male_e4","percent_male_e3")
rownames(df) <- 1:nrow(df)
df$percent_difference <- abs(df$percent_male_e4 - df$percent_male_e3)
df <- df[,c(6,7,1,5,2,3,4,8)]

# write table
write.table(df, 
            "../../../results/ribo_20/reclusterMacro/DEGs/male_E4_vs_male_E3_DEGs.tsv", sep = "\t",
            quote = FALSE, row.names = FALSE)
```

## Female E4 vs Female E3, 
```{r age_de, warning=FALSE, message=FALSE, eval=FALSE}
# initialize variables
cell_types <- unique(macro.annotated$seurat_clusters)
df <- data.frame()

# loop through clusters
for (i in cell_types) {
  print(i)
  cluster <- subset(macro.annotated, seurat_clusters == i)
  Idents(cluster) <- cluster$sex_isoform
  markers <- FindMarkers(object = cluster,
                         ident.1 = "Female E4",
                         ident.2 = "Female E3",
                         only.pos = FALSE, # default
                         min.pct = 0.10,  # default
                         test.use = "MAST",
                         verbose = TRUE,
                         assay = "RNA")
  if(nrow(markers) == 0) {
    next
  }
  markers$cluster <- i
  markers$gene <- rownames(markers)
  df <- rbind(df, markers)
}

# reformat table
colnames(df)[c(3,4)] <- c("percent_female_e4","percent_female_e3")
rownames(df) <- 1:nrow(df)
df$percent_difference <- abs(df$percent_female_e4 - df$percent_female_e3)
df <- df[,c(6,7,1,5,2,3,4,8)]

# write table
write.table(df, 
            "../../../results/ribo_20/reclusterMacro/DEGs/female_E4_vs_female_E3_DEGs.tsv", sep = "\t",
            quote = FALSE, row.names = FALSE)
```

## Female E4 vs Male E4
```{r age_de, warning=FALSE, message=FALSE, eval=FALSE}
# initialize variables
cell_types <- unique(macro.annotated$seurat_clusters)
df <- data.frame()

# loop through clusters
for (i in cell_types) {
  print(i)
  cluster <- subset(macro.annotated, seurat_clusters == i)
  Idents(cluster) <- cluster$sex_isoform
  markers <- FindMarkers(object = cluster,
                         ident.1 = "Female E4",
                         ident.2 = "Male E4",
                         only.pos = FALSE, # default
                         min.pct = 0.10,  # default
                         test.use = "MAST",
                         verbose = TRUE,
                         assay = "RNA")
  if(nrow(markers) == 0) {
    next
  }
  markers$cluster <- i
  markers$gene <- rownames(markers)
  df <- rbind(df, markers)
}

# reformat table
colnames(df)[c(3,4)] <- c("percent_female_e4","percent_male_e4")
rownames(df) <- 1:nrow(df)
df$percent_difference <- abs(df$percent_female_e4 - df$percent_male_e4)
df <- df[,c(6,7,1,5,2,3,4,8)]

# write table
write.table(df, 
            "../../../results/ribo_20/reclusterMacro/DEGs/female_E4_vs_male_E4_DEGs.tsv", sep = "\t",
            quote = FALSE, row.names = FALSE)
```

## Female E3 vs Male E3
```{r age_de, warning=FALSE, message=FALSE, eval=FALSE}
# initialize variables
cell_types <- unique(macro.annotated$seurat_clusters)
df <- data.frame()

# loop through clusters
for (i in cell_types) {
  print(i)
  cluster <- subset(macro.annotated, seurat_clusters == i)
  Idents(cluster) <- cluster$sex_isoform
  markers <- FindMarkers(object = cluster,
                         ident.1 = "Female E3",
                         ident.2 = "Male E3",
                         only.pos = FALSE, # default
                         min.pct = 0.10,  # default
                         test.use = "MAST",
                         verbose = TRUE,
                         assay = "RNA")
  if(nrow(markers) == 0) {
    next
  }
  markers$cluster <- i
  markers$gene <- rownames(markers)
  df <- rbind(df, markers)
}

# reformat table
colnames(df)[c(3,4)] <- c("percent_female_e3","percent_male_e3")
rownames(df) <- 1:nrow(df)
df$percent_difference <- abs(df$percent_female_e3 - df$percent_male_e3)
df <- df[,c(6,7,1,5,2,3,4,8)]

# write table
write.table(df, 
            "../../../results/ribo_20/reclusterMacro/DEGs/female_E3_vs_male_E3_DEGs.tsv", sep = "\t",
            quote = FALSE, row.names = FALSE)
```

# DEG tables and plots
## Compare DEGs
```{r,eval=FALSE}
# read tables
isoform.df <- read.table(
  "../../../results/ribo_20/reclusterMacro/DEGs/E4_vs_E3_DEGs.tsv",
  sep = "\t", header = TRUE)
age.df <- read.table(
  "../../../results/ribo_20/reclusterMacro/DEGs/14_vs_2_months_DEGs.tsv",
  sep = "\t", header = TRUE)
sex.df <- read.table(
  "../../../results/ribo_20/reclusterMacro/DEGs/female_vs_male_DEGs.tsv",
  sep = "\t", header = TRUE)
m4.m3 <- read.table(
  "../../../results/ribo_20/reclusterMacro/DEGs/male_E4_vs_male_E3_DEGs.tsv",
  sep = "\t", header = TRUE)
f4.f3 <- read.table(
  "../../../results/ribo_20/reclusterMacro/DEGs/female_E4_vs_female_E3_DEGs.tsv",
  sep = "\t", header = TRUE)
f4.m4 <- read.table(
  "../../../results/ribo_20/reclusterMacro/DEGs/female_E4_vs_male_E4_DEGs.tsv",
  sep = "\t", header = TRUE)
f3.m3 <- read.table(
  "../../../results/ribo_20/reclusterMacro/DEGs/female_E3_vs_male_E3_DEGs.tsv",
  sep = "\t", header = TRUE)

# filter
isoform.df <- isoform.df[isoform.df$p_val_adj < 0.05,]
age.df <- age.df[age.df$p_val_adj < 0.05,]
sex.df <- sex.df[sex.df$p_val_adj < 0.05,]
m4.m3 <- m4.m3[m4.m3$p_val_adj < 0.05,]
f4.f3 <- f4.f3[f4.f3$p_val_adj < 0.05,]
f4.m4 <- f4.m4[f4.m4$p_val_adj < 0.05,]
f3.m3 <- f3.m3[f3.m3$p_val_adj < 0.05,]

# add columns
# isoform
direction <- isoform.df$avg_log2FC > 0
direction <- gsub(TRUE, "isoform_up", direction)
direction <- gsub(FALSE, "isoform_down", direction)
isoform.df$direction <- direction
# age
direction <- age.df$avg_log2FC > 0
direction <- gsub(TRUE, "age_up", direction)
direction <- gsub(FALSE, "age_down", direction)
age.df$direction <- direction
# sex
direction <- sex.df$avg_log2FC > 0
direction <- gsub(TRUE, "sex_up", direction)
direction <- gsub(FALSE, "sex_down", direction)
sex.df$direction <- direction
# male e4 vs male e3
direction <- m4.m3$avg_log2FC > 0
direction <- gsub(TRUE, "m4_vs_m3_up", direction)
direction <- gsub(FALSE, "m4_vs_m3_down", direction)
m4.m3$direction <- direction
# female e4 vs female e3
direction <- f4.f3$avg_log2FC > 0
direction <- gsub(TRUE, "f4_vs_f3_up", direction)
direction <- gsub(FALSE, "f4_vs_f3_down", direction)
f4.f3$direction <- direction
# female e4 vs male e4
direction <- f4.m4$avg_log2FC > 0
direction <- gsub(TRUE, "f4_vs_m4_up", direction)
direction <- gsub(FALSE, "f4_vs_m4_down", direction)
f4.m4$direction <- direction
# female e3 vs male e3
direction <- f3.m3$avg_log2FC > 0
direction <- gsub(TRUE, "f3_vs_m3_up", direction)
direction <- gsub(FALSE, "f3_vs_m3_down", direction)
f3.m3$direction <- direction

# reformat tables
isoform.df2 <- isoform.df %>%
  dplyr::count(cluster,direction) %>%
  tidyr::spread(cluster, n)
age.df2 <- age.df %>%
  dplyr::count(cluster,direction) %>%
  tidyr::spread(cluster, n)
sex.df2 <- sex.df %>%
  dplyr::count(cluster,direction) %>%
  tidyr::spread(cluster, n)
m4.m3.df <- m4.m3 %>%
  dplyr::count(cluster,direction) %>%
  tidyr::spread(cluster, n)
f4.f3.df <- f4.f3 %>%
  dplyr::count(cluster,direction) %>%
  tidyr::spread(cluster, n)
f4.m4.df <- f4.m4 %>%
  dplyr::count(cluster,direction) %>%
  tidyr::spread(cluster, n)
f3.m3.df <- f3.m3 %>%
  dplyr::count(cluster,direction) %>%
  tidyr::spread(cluster, n)

# master table
df <- smartbind(isoform.df2, sex.df2, age.df2,
                m4.m3.df, f4.f3.df, f4.m4.df, f3.m3.df)
df
```

```{r,echo=FALSE,eval=FALSE}
# save
write.table(
  df, 
  "../../../results/ribo_20/reclusterMacro/DEGs/DEG_comparison_pvaladj_0.05.tsv",
  sep = "\t", quote = FALSE, row.names = FALSE)
```

## Upset plot
```{r upset_plots,eval=FALSE}
# read tables
isoform.df <- read.table("../../../results/ribo_20/reclusterMacro/DEGs/E4_vs_E3_DEGs.tsv",
                         sep = "\t", header = TRUE)
age.df <- read.table("../../../results/ribo_20/reclusterMacro/DEGs/14_vs_2_months_DEGs.tsv",
                         sep = "\t", header = TRUE)
sex.df <- read.table("../../../results/ribo_20/reclusterMacro/DEGs/female_vs_male_DEGs.tsv",
                         sep = "\t", header = TRUE)

# filter tables
isoform.df <- isoform.df[isoform.df$p_val_adj < 0.05,]
age.df <- age.df[age.df$p_val_adj < 0.05,]
sex.df <- sex.df[sex.df$p_val_adj < 0.05,]

clusters <- unique(macro.annotated$seurat_clusters)
for (i in clusters) {
  # Subset df by cluster
  isoform <- subset(isoform.df, isoform.df$cluster == i)
  sex <- subset(sex.df, sex.df$cluster == i)
  age <- subset(age.df, age.df$cluster == i)
  
  # Subset lists
  isoform_up <- subset(isoform$gene, isoform$avg_log2FC > 0)
  isoform_down <- subset(isoform$gene, isoform$avg_log2FC < 0)
  sex_up <- subset(sex$gene, sex$avg_log2FC > 0)
  sex_down <- subset(sex$gene, sex$avg_log2FC < 0)
  age_up <- subset(age$gene, age$avg_log2FC > 0)
  age_down <- subset(age$gene, age$avg_log2FC < 0)
  list_input <- list("Age Up-regulated" = age_up,
                     "Isoform Up-regulated" = isoform_up,
                     "Sex Up-regulated" = sex_up,
                     "Age Down-regulated" = age_down,
                     "Isoform Down-regulated" = isoform_down,
                     "Sex Down-regulated" = sex_down)
  data <- fromList(list_input)
  
  # store names
  names <- c("Sex Down-regulated","Isoform Down-regulated","Age Down-regulated",
             "Sex Up-regulated","Isoform Up-regulated","Age Up-regulated")
  
  # plot
  upset_gene <- ComplexUpset::upset(data, 
                      names,
                      set_sizes=(
                        upset_set_size()
                        + geom_text(aes(label=..count..), hjust=1.1, stat='count')
                        + expand_limits(y=200)),
                      queries = list(upset_query("Age Up-regulated", fill = "red"),
                                     upset_query("Isoform Up-regulated", fill = "red"),
                                     upset_query("Sex Up-regulated", fill = "red"),
                                     upset_query("Age Down-regulated", fill = "blue"),
                                     upset_query("Isoform Down-regulated", fill = "blue"),
                                     upset_query("Sex Down-regulated", fill = "blue")),
                      base_annotations = list('Intersection size' = (
                        intersection_size(bar_number_threshold=1, width=0.1)
                        + scale_y_continuous(expand=expansion(mult=c(0, 0.05)),limits = c(0,120)) # space on top
                        + theme(
                              # hide grid lines
                              panel.grid.major=element_blank(),
                              panel.grid.minor=element_blank(),
                              # show axis lines
                              axis.line=element_line(colour='black')))),
                      stripes = upset_stripes(
                        geom=geom_segment(size=12),  # make the stripes larger
                        colors=c('grey95', 'white')),
                      # to prevent connectors from getting the colorured
                      # use `fill` instead of `color`, together with `shape='circle filled'`
                      matrix = intersection_matrix(
                        geom=geom_point(
                          shape='circle filled',
                          size=3,
                          stroke=0.45)),
                      sort_sets=FALSE,
                      sort_intersections='descending'
                    )
  upset_gene <- upset_gene + ggtitle(paste0(i,", adj_p_val < 0.05"))
  i <- gsub(" ","_",i)
  i <- gsub("/","_",i)
  i <- gsub("-","_",i)
  pdf(paste0("../../../results/ribo_20/reclusterMacro/upset/upset_",tolower(i),".pdf"), height = 6, width = 8)
  print(upset_gene)
  dev.off()
}
```

## Volcano
### Part 1
```{r volcano_plot, message=FALSE, eval=FALSE}
variables <- c("sex","age","isoform")
all_clusters <- unique(macro.annotated$seurat_clusters)

for (i in variables) {
  
  # read DEG file
  if (i == "sex") {
    treatment_vs_control <- 
      read.delim("../../../results/ribo_20/reclusterMacro/DEGs/female_vs_male_DEGs.tsv",
                 sep = "\t")
  } else if (i == "age") {
    treatment_vs_control <-
      read.delim("../../../results/ribo_20/reclusterMacro/DEGs/14_vs_2_months_DEGs.tsv",
                 sep = "\t")
  } else {
    treatment_vs_control <-
      read.delim("../../../results/ribo_20/reclusterMacro/DEGs/E4_vs_E3_DEGs.tsv",
                 sep = "\t")
  }
  
  # assign colors
  color_values <- vector()
  max <- nrow(treatment_vs_control)
  for(row in 1:max){
    if (treatment_vs_control$p_val_adj[row] < 0.05){
      if (treatment_vs_control$avg_log2FC [row] > 0){
        color_values <- c(color_values, 1) # 1 when logFC > 0 and FDRq < 0.05
      }
      else if (treatment_vs_control$avg_log2FC[row] < 0){
        color_values <- c(color_values, 2) # 2 when logFC < 0 and FDRq < 0.05
      }
    }
    else{
      color_values <- c(color_values, 3) # 3 when FDRq >= 0.05
    }
  }
  treatment_vs_control$color_adjpval_0.05 <- factor(color_values)
  
  # loop through clusters
  for (j in all_clusters) {
    
    # subset cluster
    data <- subset(treatment_vs_control, cluster == j)
    
    # plot only if there are DEGs with p_val_adj < 0.05
    num <- subset(data, p_val_adj < 0.05)
    num <- nrow(num)
    if(num != 0) {
        
      # subset genes to label
      up <- data[data$color_adjpval_0.05 == 1,]
      up10 <- up[1:10,]
      down <- data[data$color_adjpval_0.05 == 2,]
      down10 <- down[1:10,]
      
      # set manual colors
      if (!1 %in% unique(data$color_adjpval_0.05)) {
        my_colors <- c("blue","gray")
      } else if (!2 %in% unique(data$color_adjpval_0.05)) {
        my_colors <- c("red","gray")
      } else if (!1 %in% unique(data$color_adjpval_0.05) && !2 %in% unique(data$color_adjpval_0.05)) {
        my_colors <- c("gray")
      } else {
        my_colors <- c("red","blue","gray")
      }
      
      # set significance threshold
      hadjpval <- (-log10(max(
        data$p_val[data$p_val_adj < 0.05], 
        na.rm=TRUE)))

      # plot
      p <-
        ggplot(data = data, 
               aes(x = avg_log2FC,  # x-axis is logFC
                   y = -log10(p_val),  # y-axis will be -log10 of P.Value
                   color = color_adjpval_0.05)) +  # color is based on factored color column
        geom_point(alpha = 0.8, size = 2) +  # create scatterplot, alpha makes points transparent
        theme_bw() +  # set color theme
        theme(legend.position = "none") +  # no legend
        scale_color_manual(values = my_colors) +  # set factor colors
        labs(
          title = "", # no main title
          x = expression(log[2](FC)), # x-axis title
          y = expression(-log[10] ~ "(" ~ italic("p") ~ "-value)") # y-axis title
        ) +
        theme(axis.title.x = element_text(size = 10),
              axis.text.x = element_text(size = 10)) +
        theme(axis.title.y = element_text(size = 10),
              axis.text.y = element_text(size = 10)) +
        geom_hline(yintercept = hadjpval,  #  horizontal line
                           colour = "#000000",
                           linetype = "dashed") +
        ggtitle(paste0(j,"\n",i,", p_val_adj < 0.05")) +
        geom_text_repel(data = up10,
                        aes(x = avg_log2FC, y= -log10(p_val), label = gene), 
                        color = "maroon", 
                        fontface="italic",
                        max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                        ) +
        geom_text_repel(data = down10,
                        aes(x = avg_log2FC, y= -log10(p_val), label = gene), 
                        color = "navyblue", 
                        fontface="italic",
                        max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                        )
      p
      
      # save
      clus <- j
      clus <- gsub(" ","_",clus)
      clus <- gsub("/","_",clus)
      clus <- gsub("-","_",clus)
      if (i == "sex") {
        path <- paste0("../../../results/ribo_20/reclusterMacro/volcano/sex/",
                       tolower(clus),"_sex_volcano")
      } else if (i == "age") {
        path <- paste0("../../../results/ribo_20/reclusterMacro/volcano/age/",
                       tolower(clus),"_age_volcano")      
      } else {
        path <- paste0("../../../results/ribo_20/reclusterMacro/volcano/isoform/",
                       tolower(clus),"_isoform_volcano")      
      }
      pdf(paste(path,".pdf"), height = 8, width = 8)
      print(p)
      dev.off()
      
      print(paste("i =",i,", j =",j))
      
    }
  } # end loop through clusters
} # end loop through variables
```

### Part 2
```{r volcano_plot, message=FALSE, eval=FALSE}
variables <- c("M4_vs_M3","F4_vs_F3","F4_vs_M4","F3_vs_M3")
all_clusters <- unique(macro.annotated$seurat_clusters)

for (i in variables) {
  
  # read DEG file
  if (i == "M4_vs_M3") {
    treatment_vs_control <- 
      read.delim("../../../results/ribo_20/reclusterMacro/DEGs/male_E4_vs_male_E3_DEGs.tsv",
                 sep = "\t")
  } else if (i == "F4_vs_F3") {
    treatment_vs_control <-
      read.delim("../../../results/ribo_20/reclusterMacro/DEGs/female_E4_vs_female_E3_DEGs.tsv",
                 sep = "\t")
  } else if (i == "F4_vs_M4") {
    treatment_vs_control <-
      read.delim("../../../results/ribo_20/reclusterMacro/DEGs/female_E4_vs_male_E4_DEGs.tsv",
                 sep = "\t")
  } else {
    treatment_vs_control <-
      read.delim("../../../results/ribo_20/reclusterMacro/DEGs/female_E3_vs_male_E3_DEGs.tsv",
                 sep = "\t")
  }
  
  # assign colors
  color_values <- vector()
  max <- nrow(treatment_vs_control)
  for(row in 1:max){
    if (treatment_vs_control$p_val_adj[row] < 0.05){
      if (treatment_vs_control$avg_log2FC [row] > 0){
        color_values <- c(color_values, 1) # 1 when logFC > 0 and FDRq < 0.05
      }
      else if (treatment_vs_control$avg_log2FC[row] < 0){
        color_values <- c(color_values, 2) # 2 when logFC < 0 and FDRq < 0.05
      }
    }
    else{
      color_values <- c(color_values, 3) # 3 when FDRq >= 0.05
    }
  }
  treatment_vs_control$color_adjpval_0.05 <- factor(color_values)
  
  # loop through clusters
  for (j in all_clusters) {
    
    # subset cluster
    data <- subset(treatment_vs_control, cluster == j)
    
    # plot only if there are DEGs with p_val_adj < 0.05
    num <- subset(data, p_val_adj < 0.05)
    num <- nrow(num)
    if(num != 0) {
        
      # subset genes to label
      up <- data[data$color_adjpval_0.05 == 1,]
      up10 <- up[1:10,]
      down <- data[data$color_adjpval_0.05 == 2,]
      down10 <- down[1:10,]
      
      # set manual colors
      if (!1 %in% unique(data$color_adjpval_0.05)) {
        my_colors <- c("blue","gray")
      } else if (!2 %in% unique(data$color_adjpval_0.05)) {
        my_colors <- c("red","gray")
      } else if (!1 %in% unique(data$color_adjpval_0.05) && !2 %in% unique(data$color_adjpval_0.05)) {
        my_colors <- c("gray")
      } else {
        my_colors <- c("red","blue","gray")
      }
      
      # set significance threshold
      hadjpval <- (-log10(max(
        data$p_val[data$p_val_adj < 0.05], 
        na.rm=TRUE)))

      # plot
      p <-
        ggplot(data = data, 
               aes(x = avg_log2FC,  # x-axis is logFC
                   y = -log10(p_val),  # y-axis will be -log10 of P.Value
                   color = color_adjpval_0.05)) +  # color is based on factored color column
        geom_point(alpha = 0.8, size = 2) +  # create scatterplot, alpha makes points transparent
        theme_bw() +  # set color theme
        theme(legend.position = "none") +  # no legend
        scale_color_manual(values = my_colors) +  # set factor colors
        labs(
          title = "", # no main title
          x = expression(log[2](FC)), # x-axis title
          y = expression(-log[10] ~ "(" ~ italic("p") ~ "-value)") # y-axis title
        ) +
        theme(axis.title.x = element_text(size = 10),
              axis.text.x = element_text(size = 10)) +
        theme(axis.title.y = element_text(size = 10),
              axis.text.y = element_text(size = 10)) +
        geom_hline(yintercept = hadjpval,  #  horizontal line
                           colour = "#000000",
                           linetype = "dashed") +
        ggtitle(paste0(j,"\n",i,", p_val_adj < 0.05")) +
        geom_text_repel(data = up10,
                        aes(x = avg_log2FC, y= -log10(p_val), label = gene), 
                        color = "maroon", 
                        fontface="italic",
                        max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                        ) +
        geom_text_repel(data = down10,
                        aes(x = avg_log2FC, y= -log10(p_val), label = gene), 
                        color = "navyblue", 
                        fontface="italic",
                        max.overlaps = getOption("ggrepel.max.overlaps", default = 30)
                        )
      p
      
      # save
      clus <- j
      clus <- gsub(" ","_",clus)
      clus <- gsub("/","_",clus)
      clus <- gsub("-","_",clus)
      if (i == "M4_vs_M3") {
        path <- paste0("../../../results/ribo_20/reclusterMacro/volcano/M4_vs_M3/",
                       tolower(clus),"_M4_vs_M3_volcano")
      } else if (i == "F4_vs_F3") {
        path <- paste0("../../../results/ribo_20/reclusterMacro/volcano/F4_vs_F3/",
                       tolower(clus),"_F4_vs_F3_volcano")      
      } else if (i == "F4_vs_M4") {
        path <- paste0("../../../results/ribo_20/reclusterMacro/volcano/F4_vs_M4/",
                       tolower(clus),"_F4_vs_M4_volcano")      
      } else {
        path <- paste0("../../../results/ribo_20/reclusterMacro/volcano/F3_vs_M3/",
                       tolower(clus),"_F3_vs_M3_volcano")      
      }
      pdf(paste(path,".pdf"), height = 8, width = 8)
      print(p)
      dev.off()
      
      print(paste("i =",i,", j =",j))
      
    }
  } # end loop through clusters
} # end loop through variables
```

# Shiny App
## Cleanup object
```{r,eval=FALSE}
macro.annotated@assays$RNA@var.features <- 
  macro.annotated@assays$SCT@var.features
metadata <- macro.annotated@meta.data
metadata <- metadata[,c(24,25,2:22)]
macro.annotated@meta.data <- metadata
macro.annotated@assays$SCT@meta.features <- metadata
macro.annotated@assays$RNA@meta.features <- metadata
```

## Output directory
```{r, eval=FALSE}
# make shiny folder
DefaultAssay(macro.annotated) <- "RNA"
Idents(macro.annotated) <- "seurat_clusters"
sc.config <- createConfig(macro.annotated)
makeShinyApp(macro.annotated, sc.config, gene.mapping = TRUE,
             shiny.title = "Recluster Macrophages & Monocytes") 
```
